- defaultTab: nodes
  description: 'Run an health check on a Linux host - CPU, Memory and disk space.'
  executionEnabled: true
  group: Healthcheck
  id: 532f0968-75f7-444f-bf1c-3891a799e730
  loglevel: INFO
  multipleExecutions: true
  name: System Healthcheck (Linux)
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: true
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: .*worker.*
  nodesSelectedByDefault: true
  options:
  - name: pd_incident_id
  plugins:
    ExecutionLifecycle:
      Send Incident Output to Pagerduty: {}
  runnerSelector:
    filter: BDIAS
    runnerFilterMode: TAGS
    runnerFilterType: TAG_FILTER_AND
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
    - autoSecureInput: 'false'
      description: Disk Space
      passSecureInput: 'false'
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'false'
            hideOutput: 'false'
            logData: 'false'
            name: disk-result
            regex: (.*)
          type: key-value-data-multilines
      script: |
        #!/bin/bash

        echo "1. Check disk space"
        disk_output=$(df -H / | grep -v Filesystem | awk '{print $5 " " $6}')
        used_pct=$(echo $disk_output | awk '{print $1}' | sed 's/%//')
        echo "Filesystem      Size  Used Avail Use% Mounted on"
        df -H / | grep -v Filesystem
        if [ "$used_pct" -ge 90 ]; then
          echo "游댮 Fault detected: Disk usage critical on ${disk_output}"
        else
          echo "游릭 No fault detected: Disk usage within normal parameters (${disk_output})"
        fi
        echo ""
    - autoSecureInput: 'false'
      description: Top 5 processes by CPU utilization
      passSecureInput: 'false'
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'false'
            hideOutput: 'false'
            logData: 'false'
            name: cpu-result
            regex: (.*)
          type: key-value-data-multilines
      script: |
        #!/bin/bash

        echo "2. Top 5 processes by CPU utilization"
        cpu_output=$(ps -eo pid,comm,%cpu --sort=-%cpu | head -n 6)
        echo "$cpu_output"

        top_cpu=$(echo "$cpu_output" | awk 'NR==2 {print $3}')
        if (( $(echo "$top_cpu > 80" | bc -l) )); then
          echo "游댮 Fault detected: High CPU usage detected (${top_cpu}%)"
        else
          echo "游릭 No fault detected: CPU usage within normal parameters"
        fi
        echo ""
    - autoSecureInput: 'false'
      description: Top 5 Processes by Memory Usage
      passSecureInput: 'false'
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'false'
            hideOutput: 'false'
            logData: 'false'
            name: memory-result
            regex: (.*)
          type: key-value-data-multilines
      script: |
        #!/bin/bash

        echo "3. Top 5 Processes by Memory Usage"
        mem_output=$(ps -eo pid,comm,%mem --sort=-%mem | head -n 6)
        echo "$mem_output"

        top_mem=$(echo "$mem_output" | awk 'NR==2 {print $3}')
        if (( $(echo "$top_mem > 80" | bc -l) )); then
          echo "游댮 Fault detected: High memory usage detected (${top_mem}%)"
        else
          echo "游릭 No fault detected: Memory usage within normal parameters"
        fi
        echo ""
    - autoSecureInput: 'false'
      description: Network usage
      passSecureInput: 'false'
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'false'
            hideOutput: 'false'
            logData: 'false'
            name: network-result
            regex: (.*)
          type: key-value-data-multilines
      script: |
        #!/bin/bash

        echo "4. Network usage"
        ifstat -t 1 5
        echo "游릭 Network statistics captured"
        echo ""
    - autoSecureInput: 'false'
      description: System load
      passSecureInput: 'false'
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'false'
            hideOutput: 'false'
            logData: 'false'
            name: load-result
            regex: (.*)
          type: key-value-data-multilines
      script: |
        #!/bin/bash

        echo "5. System load"
        uptime_output=$(uptime)
        echo "$uptime_output"

        load_avg=$(echo "$uptime_output" | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
        cpu_count=$(nproc)
        load_threshold=$(echo "$cpu_count * 0.8" | bc)

        if (( $(echo "$load_avg > $load_threshold" | bc -l) )); then
          echo "游댮 Fault detected: High system load (${load_avg} on ${cpu_count} CPUs)"
        else
          echo "游릭 No fault detected: System load within normal parameters (${load_avg} on ${cpu_count} CPUs)"
        fi
        echo ""
    - configuration:
        incident_id: ${option.pd_incident_id}
        note: |-
          Disk space check results:
          ${data.disk-result*}
      nodeStep: false
      type: pd-note-step
    keepgoing: true
    pluginConfig:
      LogFilter:
      - config:
          filterName: System healthcheck logs
          logOutputSettings: All
          regexPattern: (.*)
          stepStatus: Any
        type: pagerduty-incident-output-capture
    strategy: node-first
  tags: automation-actions
  timeout: 5m
  user: admin
  uuid: 532f0968-75f7-444f-bf1c-3891a799e730

