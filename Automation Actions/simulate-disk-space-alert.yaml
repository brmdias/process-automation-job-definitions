- defaultTab: output
  description: |-
    Simulates a disk space alert workflow in PagerDuty for testing and demonstration purposes.

    This job demonstrates automated incident lifecycle management by:
    1. Triggering a PagerDuty alert simulating a critical disk space issue
    2. Waiting for 2.5 minutes to simulate investigation/remediation time
    3. Automatically resolving the alert to close the incident

    Use case: Testing PagerDuty integrations, incident response workflows, and automated remediation patterns.

    Estimated duration: 2.5 minutes
  executionEnabled: true
  group: Automation Actions
  id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
  loglevel: INFO
  name: simulate-disk-space-alert
  nodeFilterEditable: false
  options:
  - description: The hostname or system identifier where the disk space issue is occurring
    label: Hostname
    name: hostname
    required: true
    type: text
    value: server-prod-01
  - description: The disk partition experiencing space issues
    label: Disk Partition
    name: partition
    required: true
    type: text
    value: /dev/sda1
  - description: Current disk usage percentage
    label: Disk Usage (%)
    name: disk_usage
    required: true
    type: text
    value: '95'
  - description: Disk usage threshold that triggered the alert
    label: Threshold (%)
    name: threshold
    required: true
    type: text
    value: '90'
  - description: PagerDuty Integration Key (routing key) from Key Storage
    label: PagerDuty Integration Key
    name: pd_integration_key
    required: true
    secure: true
    storagePath: keys/pagerduty/pdt-bdias-global-orchestration-key
    valueExposed: true
  plugins:
    ExecutionLifecycle: {}
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
    - description: Trigger PagerDuty Alert - Disk Space Critical
      script: |-
        #!/bin/bash

        # PagerDuty Events API v2 endpoint
        PD_URL="https://events.pagerduty.com/v2/enqueue"

        # Build the JSON payload
        PAYLOAD=$(cat <<EOF
        {
          "routing_key": "${option.pd_integration_key}",
          "event_action": "trigger",
          "dedup_key": "disk-space-${option.hostname}-${job.execid}",
          "payload": {
            "summary": "ðŸš¨ Critical Disk Space Alert on ${option.hostname} - ${option.partition} at ${option.disk_usage}% usage (threshold: ${option.threshold}%)",
            "severity": "critical",
            "source": "Runbook Automation",
            "component": "${option.hostname}",
            "class": "disk_space_monitoring",
            "custom_details": {
              "hostname": "${option.hostname}",
              "partition": "${option.partition}",
              "current_usage": "${option.disk_usage}%",
              "threshold": "${option.threshold}%",
              "mount_point": "${option.partition}",
              "triggered_by": "Runbook Automation - Simulated Alert",
              "execution_id": "${job.execid}",
              "job_name": "${job.name}"
            }
          },
          "images": [
            {
              "src": "https://www.rundeck.com/hubfs/rundeck-app-assets/rundeck-by-pagerduty-icon.png",
              "alt": "Rundeck by PagerDuty"
            }
          ],
          "links": [
            {
              "href": "${job.url}",
              "text": "View Runbook Execution"
            }
          ]
        }
        EOF
        )

        # Send the event to PagerDuty
        echo "Sending trigger event to PagerDuty..."
        RESPONSE=$(curl -s -X POST "$PD_URL" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD")

        # Check response
        if echo "$RESPONSE" | grep -q '"status":"success"'; then
          echo "âœ… PagerDuty alert triggered successfully"
          echo "Response: $RESPONSE"
        else
          echo "âŒ Failed to trigger PagerDuty alert"
          echo "Response: $RESPONSE"
          exit 1
        fi
    - description: Wait for 2.5 minutes before resolving the alert
      exec: sleep 150
    - description: Resolve PagerDuty Alert - Disk Space Remediated
      script: |-
        #!/bin/bash

        # PagerDuty Events API v2 endpoint
        PD_URL="https://events.pagerduty.com/v2/enqueue"

        # Build the JSON payload for resolve event
        PAYLOAD=$(cat <<EOF
        {
          "routing_key": "${option.pd_integration_key}",
          "event_action": "resolve",
          "dedup_key": "disk-space-${option.hostname}-${job.execid}",
          "payload": {
            "summary": "âœ… Disk Space Alert Resolved on ${option.hostname} - ${option.partition} cleaned up successfully",
            "severity": "info",
            "source": "Runbook Automation",
            "custom_details": {
              "hostname": "${option.hostname}",
              "partition": "${option.partition}",
              "resolution": "Disk space cleaned up - automated cleanup completed",
              "resolved_by": "Runbook Automation - Automated Remediation",
              "execution_id": "${job.execid}",
              "job_name": "${job.name}"
            }
          }
        }
        EOF
        )

        # Send the resolve event to PagerDuty
        echo "Sending resolve event to PagerDuty..."
        RESPONSE=$(curl -s -X POST "$PD_URL" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD")

        # Check response
        if echo "$RESPONSE" | grep -q '"status":"success"'; then
          echo "âœ… PagerDuty alert resolved successfully"
          echo "Response: $RESPONSE"
        else
          echo "âŒ Failed to resolve PagerDuty alert"
          echo "Response: $RESPONSE"
          exit 1
        fi
    keepgoing: false
    strategy: node-first
  tags: pagerduty,automation,testing,disk-space,incident-simulation,demonstration
  user: admin
  uuid: a1b2c3d4-e5f6-7890-abcd-ef1234567890
