- defaultTab: nodes
  description: "The \"job-re-run\" is an automated process designed to re-execute\
    \ a specific job in Rundeck using a provided Execution ID. \n\nThis job integrates\
    \ with PagerDuty to log the re-run status and execution details as an incident\
    \ note. \n\nIt retrieves execution logs, monitors the status of the re-run, and\
    \ ensures that the results are communicated effectively. \n\nThe job is particularly\
    \ useful for automating incident management workflows and ensuring transparency\
    \ in job execution.\n\nEstimated duration: 2-5 minutes depending on job execution\
    \ time."
  executionEnabled: true
  group: Automation Actions
  id: 94cafc29-0a89-4d2f-a5de-321ef64920df
  loglevel: INFO
  name: job-re-run
  nodeFilterEditable: false
  options:
  - description: The unique identifier of the Rundeck execution to be re-run.
    label: Execution ID
    name: execution-id
    required: true
    type: text
  - description: PagerDuty incident ID to log execution results.
    label: PagerDuty Incident ID
    name: pd_incident_id
    required: true
    type: text
  - description: PagerDuty user email for API authentication.
    label: PagerDuty User Email
    name: pd_user_email
    required: true
    type: text
  - hidden: true
    name: rba-token
    secure: true
    storagePath: keys/rba-api-token
    valueExposed: true
  - description: The base URL of the Rundeck instance where the job will be executed.
    label: RBA URL
    name: rba-url
    required: true
    type: text
    value: https://<runbook-automation-url>
  - hidden: true
    name: pd-api-token
    secure: true
    storagePath: keys/pagerduty/api-token
    valueExposed: true
  plugins:
    ExecutionLifecycle:
      Send Incident Output to Pagerduty: {}
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
    - configuration:
        executions: ${option.execution-id}
        failed nodes: 'false'
        json display: 'true'
      description: job-re-run
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            extraQuotes: 'false'
            filter: .[0].id
            logData: 'true'
            prefix: execId
          type: json-mapper
        - config:
            extraQuotes: 'false'
            filter: .[0].job.id
            logData: 'true'
            prefix: job-uuid
          type: json-mapper
        - config:
            extraQuotes: 'false'
            filter: .[0].job.jobName
            logData: 'true'
            prefix: job-name
          type: json-mapper
        - config:
            extraQuotes: 'false'
            filter: .[0].project
            logData: 'true'
            prefix: project
          type: json-mapper
      type: run-executions
    - configuration:
        executions: ${data.execId}
        fail on failed execution: 'true'
        json display: 'true'
        project: ${data.project}
      description: wait-for-execution
      errorhandler:
        configuration:
          export: execution-status
          group: data
          value: failed
        keepgoingOnSuccess: true
        nodeStep: false
        type: export-var
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            extraQuotes: 'false'
            filter: .[0].status
            logData: 'true'
            prefix: execution-status
          type: json-mapper
      type: result-executions
    - configuration:
        authentication: None
        headers: |
          Accept: application/yaml
          X-Rundeck-Auth-Token: ${option.rba-token}
        method: GET
        printResponse: 'true'
        printResponseCode: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: ${option.rba-url}/api/52/execution/${data.execId}/output?format=text
        responseCode: 2xx
        sslVerify: 'true'
        timeout: '30000'
      description: get-logs-from-rerun-execution
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - configuration:
        api_token: ${option.pd-api-token}
        email: ${option.pd_user_email}
        incident_id: ${option.pd_incident_id}
        note: |-
          ⚙️ Job re-run was triggered by Automation Actions.

          Job name: ${data.job-name}
          Re-run status: ${data.execution-status}
          Execution logs of re-run: ${option.rba-url}project/${data.project}/execution/show/${data.execId}
      description: add-incident-note
      nodeStep: false
      type: pd-note-step
    - configuration:
        api_token: ${option.pd-api-token}
        incident_id: ${option.pd_incident_id}
        resolution: Job re-run was successful.
        status: resolved
      description: resolve-incident
      nodeStep: false
      type: pd-update-incident-step
    keepgoing: true
    pluginConfig:
      LogFilter:
      - config:
          filterName: job-re-run
          logOutputSettings: All
          regexPattern: (.*)
          stepStatus: Any
        type: pagerduty-incident-output-capture
      WorkflowStrategy:
        ruleset:
          rules: |-
            [*] run-in-sequence
            [5] if:data.execution-status!=failed
    strategy: ruleset
  tags: 'critical,pagerduty,automation,incident-management,job-execution,rerun'
  user: admin
  uuid: 94cafc29-0a89-4d2f-a5de-321ef64920df
