- defaultTab: nodes
  description: 'Run an health check on a Linux host - CPU, Memory and disk space.'
  executionEnabled: true
  group: Automation Actions
  id: 532f0968-75f7-444f-bf1c-3891a799e730
  loglevel: INFO
  multipleExecutions: true
  name: System Healthcheck (Linux)
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: true
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: .*worker.*
  nodesSelectedByDefault: true
  options:
  - name: pd_incident_id
  plugins:
    ExecutionLifecycle:
      Send Incident Output to Pagerduty: {}
  runnerSelector:
    filter: BDIAS
    runnerFilterMode: TAGS
    runnerFilterType: TAG_FILTER_AND
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
    - autoSecureInput: 'false'
      description: Disk Space
      passSecureInput: 'false'
      script: |
        #!/bin/bash

        echo "1. Check disk space"
        disk_output=$(df -H / | grep -v Filesystem | awk '{print $5 " " $6}')
        used_pct=$(echo $disk_output | awk '{print $1}' | sed 's/%//')
        echo "Filesystem      Size  Used Avail Use% Mounted on"
        df -H / | grep -v Filesystem
        if [ "$used_pct" -ge 90 ]; then
          echo "ðŸ”´ Fault detected: Disk usage critical on ${disk_output}"
        else
          echo "ðŸŸ¢ No fault detected: Disk usage within normal parameters (${disk_output})"
        fi
        echo ""
    - description: Top 5 processes by CPU utilization
      exec: 'ps -eo pid,comm,%cpu --sort=-%cpu | head -n 6'
    - description: Top 5 Processes by Memory Usage
      exec: 'ps -eo pid,comm,%mem --sort=-%mem | head -n 6'
    - description: Network usage
      exec: ifstat -t 1 5
    - description: System load
      exec: uptime
    keepgoing: true
    pluginConfig:
      LogFilter:
      - config:
          filterName: System healthcheck logs
          logOutputSettings: All
          regexPattern: (.*)
          stepStatus: Any
        type: pagerduty-incident-output-capture
    strategy: node-first
  timeout: 5m
  user: admin
  uuid: 532f0968-75f7-444f-bf1c-3891a799e730

