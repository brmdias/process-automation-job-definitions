- defaultTab: nodes
  description: >-
    Job to remove a node to the File Node Source, based in the job options
    provided.
  executionEnabled: true
  group: Node Sources
  id: b682ed6d-8a5c-4f87-aa09-f1ee10b7a5ca
  loglevel: INFO
  name: Remove node
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: .*runner
  nodesSelectedByDefault: true
  options:
    - description: This will be the YAML list key.
      label: Node Name
      name: nodename
      required: true
      value: node99
  plugins:
    ExecutionLifecycle: {}
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
      - description: Display current nodes before removal
        exec: cat /etc/rundeck/node-sources/resources.yaml
      - autoSecureInput: 'false'
        description: Remove node to File Node Source
        passSecureInput: 'false'
        script: |-
          #!/bin/bash
          set -e

          cd /etc/rundeck/node-sources

          OUTPUT_FILE="resources.yaml"
          NODENAME="@option.nodename@"

          # Check if the input contains a comma
          if [[ "$NODENAME" == *,* ]]; then
            # Split comma-separated list into array
            IFS=',' read -ra NODES <<< "$NODENAME"
            # Build yq delete expression
            keys=""
            for node in "${NODES[@]}"; do
              node=$(echo "$node" | xargs)  # Trim whitespace
              if [ -z "$keys" ]; then
                keys=".${node}"
              else
                keys="$keys, .${node}"
              fi
            done
            yq "del($keys)" -i "$OUTPUT_FILE"
          else
            yq "del(.${NODENAME})" -i "$OUTPUT_FILE"
          fi
      - description: Display updated nodes after removal
        exec: cat /etc/rundeck/node-sources/resources.yaml
    keepgoing: false
    strategy: node-first
  user: admin
  uuid: b682ed6d-8a5c-4f87-aa09-f1ee10b7a5ca
