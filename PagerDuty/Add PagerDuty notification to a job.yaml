- defaultTab: output
  description: "This Rundeck job integrates PagerDuty notifications into an existing\
    \ Rundeck job. \n\nIt automates the process of exporting a job definition, modifying\
    \ it to include PagerDuty notification settings, and re-importing the updated\
    \ job back into Rundeck. This ensures that PagerDuty alerts are triggered based\
    \ on the job's execution status.\n\n## Key Features\n1. Export Job Definition:\
    \ Retrieves the current job definition from Rundeck using the Rundeck API.\n2.\
    \ Modify Job Definition: Adds a PagerDuty notification plugin to the job's configuration.\
    \ The notification is triggered on job failure.\n3. Import Updated Job: Re-imports\
    \ the modified job definition back into Rundeck, updating the existing job.\n\n\
    ## Requirements\n- A valid Rundeck API token with permissions to export and import\
    \ jobs.\n- The UUID of the target job to be modified.\n- A PagerDuty service integration\
    \ key."
  executionEnabled: true
  group: PagerDuty
  id: 8034ef69-9aff-4553-a025-731b0f8fcacd
  loglevel: INFO
  name: Add PagerDuty notification to a job
  nodeFilterEditable: false
  options:
  - description: Please exclude `http(s)://``
    name: rundeck-server-url
    value: bdias.myrundeck.com
  - name: rba-api-token
    secure: true
    storagePath: keys/rba/bdias-rba-token
    valueExposed: true
  - description: Job UUID from the job that will be modified. Comma-separated list
      in case of multiple jobs to be updated.
    label: Target Job UUID
    name: job-ids
    value: <insert your JOB UUID>
  - description: Value for the component field in the PagerDuty event.
    label: PagerDuty Event Component
    name: component
    value: ${job.execid}
  - description: Deduplication Key used in PagerDuty events
    label: PagerDuty Event Dedup-key
    name: dedup-key
    value: ${job.id}_${job.execid}
  - description: Group field used in PagerDuty Events.
    label: PagerDuty Event Group
    name: group
    value: ${job.serverUrl}
  - description: |-
      PagerDuty Event's API URL
      EU subdomains: https://events.eu.pagerduty.com
      US subdomains: https://events.pagerduty.com
    enforced: true
    label: PagerDuty Event's API URL
    name: event-service-url
    type: text
    value: https://events.eu.pagerduty.com
    values:
    - https://events.eu.pagerduty.com
    - https://events.pagerduty.com
    valuesListDelimiter: ','
  - description: Class field from PagerDuty Event
    label: PagerDuty Event Class
    name: class
    value: ${job.executionType}
  - description: Severity field for the PagerDuty Event
    enforced: true
    label: PagerDuty Event Severity
    name: severity
    type: text
    value: critical
    values:
    - critical
    - warning
    - error
    - info
    valuesListDelimiter: ','
  - description: This will be a string value stored in the "source" column for the
      event. Default is the job name that triggered the event
    label: PagerDuty Event Source
    name: source
    type: text
    value: Runbook Automation
  - description: Alert description
    label: PagerDuty Event Summary
    name: summary
    value: '[${job.status}] \"${job.name}\" run by ${job.user} (#${job.execid})'
  - description: Service Integration Key (v2) from storage path
    label: PagerDuty Event Integration Key Path
    name: integration-key-path
    type: text
    value: keys/pagerduty/pdt-bdias-global-orchestration-key
  - description: Project name from your target job.
    label: RBA Project
    name: project
    value: bdias
  plugins:
    ExecutionLifecycle: {}
  runnerSelector:
    filter: aws
    runnerFilterMode: FILTER
    runnerFilterType: TAG_FILTER_AND
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
    - autoSecureInput: 'false'
      fileExtension: .py
      interpreterArgsQuoted: false
      passSecureInput: 'false'
      script: |-
        import requests
        import json
        import time

        # Rundeck API configuration
        RUNDECK_API_URL = "https://@option.rundeck-server-url@/api/52"  # Replace with your Rundeck server URL and API version
        API_TOKEN = "@option.rba-api-token@"  # Replace with your Rundeck API token
        JOB_IDS = "@option.job-ids@"  # Comma-separated job IDs

        # Headers for Rundeck API requests
        HEADERS = {
            "X-Rundeck-Auth-Token": API_TOKEN,
            "Content-Type": "application/json"
        }

        def export_job(job_id):
            """Export a job definition from Rundeck."""
            url = f"{RUNDECK_API_URL}/job/{job_id}?format=json"
            response = requests.get(url, headers=HEADERS)
            if response.status_code == 200:
                print(f"Job {job_id} exported successfully.")
                return response.json()
            else:
                print(f"Failed to export job {job_id}. Status code: {response.status_code}, Response: {response.text}")
                return None

        def modify_job_definition(job_definition):
            """Modify the job definition to add a notification plugin, appending to existing notifications."""
            if isinstance(job_definition, list) and len(job_definition) > 0:
                job = job_definition[0]
            else:
                raise ValueError("Job definition is not in the expected format.")

            # Define the new PagerDuty notification plugin
            new_plugin = {
                "type": "PagerDutyEventNotification",
                "configuration": {
                    "action": "trigger",
                    "component": "@option.component@",
                    "dedupe_key": "@option.dedup-key@",
                    "group": "@option.group@",
                    "images": "https://www.rundeck.com/hubfs/rundeck-app-assets/rundeck-by-pagerduty-icon.png",
                    "pagerdutyUrl": "@option.event-service-url@",
                    "payload_class": "@option.class@",
                    "payload_severity": "critical",
                    "payload_source": "@option.source@",
                    "payload_summary": "@option.summary@",
                    "service_key_storage_path": "@option.integration-key-path@"
                }
            }

            # Ensure 'notification' exists
            if "notification" not in job or not isinstance(job["notification"], dict):
                job["notification"] = {}

            # Handle 'onfailure' notifications
            onfailure = job["notification"].get("onfailure")
            if not onfailure:
                # No onfailure yet, just add the new plugin
                job["notification"]["onfailure"] = {"plugin": [new_plugin]}
            else:
                # onfailure exists
                if "plugin" in onfailure:
                    # If plugin is a dict, convert to list
                    if isinstance(onfailure["plugin"], dict):
                        onfailure["plugin"] = [onfailure["plugin"]]
                    # If plugin is already a list, just append
                    if isinstance(onfailure["plugin"], list):
                        onfailure["plugin"].append(new_plugin)
                    else:
                        # Unexpected type, replace with list
                        onfailure["plugin"] = [onfailure["plugin"], new_plugin]
                else:
                    # No plugin key, add as list
                    onfailure["plugin"] = [new_plugin]
                job["notification"]["onfailure"] = onfailure

            print("Job definition modified to append notification plugin.")
            return [job]

        def import_job(job_definition):
            """Import the updated job definition back to Rundeck."""
            url = f"{RUNDECK_API_URL}/project/@option.project@/jobs/import?fileformat=json&dupeOption=update"
            post_headers = {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Rundeck-Auth-Token': API_TOKEN
            }
            job_definition_json = json.dumps(job_definition)
            print(f"Job definition to be imported: {job_definition_json}")
            response = requests.request("POST", url, headers=post_headers, data=job_definition_json)
            if response.status_code == 200:
                print("Job imported successfully.")
            else:
                print(f"Failed to import job. Status code: {response.status_code}, Response: {response.text}")

        def main():
            # Split JOB_IDS by comma and strip whitespace
            job_ids = [jid.strip() for jid in JOB_IDS.split(",") if jid.strip()]
            for idx, job_id in enumerate(job_ids):
                print(f"\nProcessing job {idx+1}/{len(job_ids)}: {job_id}")
                job_definition = export_job(job_id)
                if not job_definition:
                    continue
                updated_job_definition = modify_job_definition(job_definition)
                import_job(updated_job_definition)
                if idx < len(job_ids) - 1:
                    print("Waiting 2 seconds before processing next job...")
                    time.sleep(2)

        if __name__ == "__main__":
            main()
      scriptInterpreter: python3 -u
    keepgoing: false
    strategy: node-first
  tags: pagerduty
  uuid: 8034ef69-9aff-4553-a025-731b0f8fcacd

