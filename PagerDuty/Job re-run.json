[ {
  "defaultTab" : "nodes",
  "description" : "Run a job, using the Job ID provided as job option.",
  "executionEnabled" : true,
  "group" : "PagerDuty",
  "id" : "a5969981-f2d8-44d9-83eb-431430bfefe4",
  "loglevel" : "INFO",
  "name" : "Job re-run",
  "nodeFilterEditable" : false,
  "nodefilters" : {
    "dispatch" : {
      "excludePrecedence" : true,
      "keepgoing" : false,
      "rankOrder" : "ascending",
      "successOnEmptyNodeFilter" : false,
      "threadcount" : "1"
    },
    "filter" : "bdias-rundeckers-a"
  },
  "nodesSelectedByDefault" : true,
  "options" : [ {
    "label" : "Execution ID",
    "name" : "execution-id",
    "type" : "text",
    "value" : "85424"
  }, {
    "hidden" : true,
    "name" : "pd_incident_id",
    "value" : "123"
  }, {
    "hidden" : true,
    "name" : "rba-token",
    "secure" : true,
    "storagePath" : "keys/bdias-rba-token",
    "valueExposed" : true
  }, {
    "label" : "RBA URL",
    "name" : "rba-url",
    "required" : true,
    "value" : "https://bdias.pd-sandbox.com"
  } ],
  "plugins" : {
    "ExecutionLifecycle" : {
      "Send Incident Output to Pagerduty" : { }
    }
  },
  "scheduleEnabled" : true,
  "schedules" : [ ],
  "sequence" : {
    "commands" : [ {
      "configuration" : {
        "executions" : "${option.execution-id}",
        "failed nodes" : "false",
        "json display" : "true"
      },
      "nodeStep" : false,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "extraQuotes" : "false",
            "filter" : ".[0].id",
            "logData" : "true",
            "prefix" : "execId"
          },
          "type" : "json-mapper"
        }, {
          "config" : {
            "extraQuotes" : "false",
            "filter" : ".[0].job.id",
            "logData" : "true",
            "prefix" : "job-uuid"
          },
          "type" : "json-mapper"
        }, {
          "config" : {
            "extraQuotes" : "false",
            "filter" : ".[0].job.jobName",
            "logData" : "true",
            "prefix" : "job-name"
          },
          "type" : "json-mapper"
        }, {
          "config" : {
            "extraQuotes" : "false",
            "filter" : ".[0].project",
            "logData" : "true",
            "prefix" : "project"
          },
          "type" : "json-mapper"
        }, {
          "config" : {
            "extraQuotes" : "false",
            "filter" : ".href",
            "logData" : "true",
            "prefix" : "execution-url"
          },
          "type" : "json-mapper"
        }, {
          "config" : {
            "extraQuotes" : "false",
            "filter" : ".status",
            "logData" : "true",
            "prefix" : "execution-status"
          },
          "type" : "json-mapper"
        } ]
      },
      "type" : "run-executions"
    }, {
      "configuration" : {
        "atLeastOne" : "false",
        "condition" : "Equals",
        "executionState" : "Succeeded",
        "interval" : "5s",
        "jobName" : "${data.job-group}/${data.job-name}",
        "jobUUID" : "${data.job-uuid}",
        "maxtry" : "60",
        "next" : "Continue",
        "project" : "${data.project}",
        "running" : "true"
      },
      "description" : "Wait for job to be completed",
      "nodeStep" : false,
      "type" : "wait-for-job"
    }, {
      "autoSecureInput" : "false",
      "description" : "Get logs from execution",
      "passSecureInput" : "false",
      "script" : "echo \"Getting logs from Execution ID @data.execId@\"\n\ncurl --location '@option.rba-url@/api/14/execution/@data.execId@/output?format=text' \\\n--header 'Accept: application/yaml' \\\n--header 'X-Rundeck-Auth-Token: @option.rba-token@'\n"
    }, {
      "configuration" : {
        "api_token" : "keys/pager-duty/pdt-bdias-api-token",
        "email" : "bdias@pagerduty.com",
        "incident_id" : "${option.pd_incident_id}",
        "note" : "Job re-run was triggered by Automation Actions.\n\nJob run: ${data.job-name}\nRe-run status: ${data.execution-status}\nExecution logs of re-run: ${data.execution-url}"
      },
      "description" : "Add an incident note",
      "nodeStep" : false,
      "type" : "pd-note-step"
    } ],
    "keepgoing" : true,
    "pluginConfig" : {
      "LogFilter" : [ {
        "config" : {
          "filterName" : "Job re-run",
          "logOutputSettings" : "All",
          "regexPattern" : "(.*)",
          "stepStatus" : "Any"
        },
        "type" : "pagerduty-incident-output-capture"
      } ]
    },
    "strategy" : "node-first"
  },
  "uuid" : "a5969981-f2d8-44d9-83eb-431430bfefe4"
} ]
