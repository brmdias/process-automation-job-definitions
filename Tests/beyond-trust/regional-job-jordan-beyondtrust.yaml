- defaultTab: nodes
  description: "Regional BeyondTrust SSH Key Management Job for Jordan\n\nThis job\
    \ automates the secure management of SSH keys for BeyondTrust integration within\
    \ the Jordan region. \nIt performs the following key operations:\n\n1. **SSH Key\
    \ Retrieval**: Retrieves SSH private keys from the local file system using the\
    \ specified file path\n2. **Key Storage Upload**: Securely uploads the SSH key\
    \ to Rundeck's centralized key storage with project-scoped access\n3. **Node Configuration**:\
    \ Updates the target node's resource definition to reference the stored key via\
    \ the 'ssh-key-storage-path' attribute\n4. **Resource Synchronization**: Ensures\
    \ node resources are properly updated with the new key storage path\n\nKey Features:\n\
    - Secure token-based authentication using RBA tokens\n- Project and node-specific\
    \ key storage organization (keys/project/{PROJECT}/{NODE_NAME})\n- Automatic node\
    \ resource updates via Rundeck API\n- Error handling with fail-fast behavior (set\
    \ -e)\n- Support for YAML-based node resource management using yq\n\nPrerequisites:\n\
    - Valid RBA token stored in keys/bdias-rba-token\n- SSH private key file accessible\
    \ on the file system\n- yq utility available for YAML processing\n- curl for API\
    \ interactions\n- Proper project and node permissions\n\nThis job is part of the\
    \ Network International test project infrastructure and is specifically designed\
    \ \nfor the Jordan regional deployment of BeyondTrust privileged access management\
    \ systems.\n"
  executionEnabled: true
  group: Tests/beyond-trust
  id: 8039298d-ff51-42f5-93ab-cc3c0b432965
  loglevel: INFO
  name: regional-job-jordan-beyondtrust
  nodeFilterEditable: true
  options:
  - hidden: true
    name: rba-token
    secure: true
    storagePath: keys/bdias-rba-token
    valueExposed: true
  - description: File system path of the key to be used.
    label: SSH Key
    name: file-key-path
    required: true
    type: text
    value: /home/rundeck/.ssh/id_rsa
  - label: Node name
    name: node-name
    required: true
    type: text
    value: pdt-bdias-test-beyondtrust
  plugins:
    ExecutionLifecycle: {}
  scheduleEnabled: false
  schedules: []
  sequence:
    commands:
    - keepgoing: false
      script: |
        #!/bin/bash
        set -e

        # 0. Install yq if not available
        if ! command -v yq &> /dev/null; then
          echo "Installing yq..."
          # For Linux systems
          if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /tmp/yq
          # For macOS systems
          elif [[ "$OSTYPE" == "darwin"* ]]; then
            curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_darwin_amd64 -o /tmp/yq
          fi
          chmod +x /tmp/yq
          export PATH="/tmp:$PATH"
        fi

        # 1. Get SSH key from the file system
        SSH_KEY_PATH="@option.file-key-path@"
        NODE_NAME="@option.node-name@"
        PROJECT="@job.project@"
        KEY_STORAGE_PATH="keys/project/${PROJECT}/nodes/${NODE_NAME}"

        echo "Using this key from file system - ${SSH_KEY_PATH}, on project - ${PROJECT} and node - ${NODE_NAME}"

        # 2. Upload this key to the key storage
        RD_API_URL="https://bdias.myrundeck.com/api/45"
        RD_API_TOKEN="@option.rba-token@"
        curl -X POST "${RD_API_URL}/storage/${KEY_STORAGE_PATH}" \
          -H "X-Rundeck-Auth-Token: ${RD_API_TOKEN}" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @"${SSH_KEY_PATH}"

        echo "Key Successfully uploaded to the Key Storage."

        # 3. Update node attribute with key storage path
        NODE_YAML=$(mktemp)
        curl -s -H "X-Rundeck-Auth-Token: ${RD_API_TOKEN}" \
          -H 'Accept: application/yaml' \
          "${RD_API_URL}/project/${PROJECT}/resources?filter=name%3A${NODE_NAME}" > "$NODE_YAML"

        echo "Before update:"
        cat "${NODE_YAML}"

        # Update or add the ssh-key-storage-path attribute for the node
        yq eval "(.[] | select(.nodename == \"${NODE_NAME}\")) |= . + {\"ssh-key-storage-path\": \"${KEY_STORAGE_PATH}\"}" "$NODE_YAML" > "${NODE_YAML}.tmp"
        mv "${NODE_YAML}.tmp" "$NODE_YAML"

        echo "After update:"
        cat "${NODE_YAML}"

        # Upload the updated node definition
        curl -X POST "${RD_API_URL}/project/${PROJECT}/source/2/resources" \
          -H "X-Rundeck-Auth-Token: ${RD_API_TOKEN}" \
          -H "Content-Type: application/yaml" \
          --data-binary @"$NODE_YAML"

        echo "Node ${NODE_NAME} was updated!"
      strategy: node-first
    keepgoing: false
    strategy: node-first
  uuid: 8039298d-ff51-42f5-93ab-cc3c0b432965

