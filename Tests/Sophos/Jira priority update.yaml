- defaultTab: nodes
  description: ''
  executionEnabled: true
  group: Tests/Sophos
  id: 9432dc5d-933c-4b92-af81-856a102a42e8
  loglevel: INFO
  name: Jira priority update
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: .*runner
  nodesSelectedByDefault: true
  options:
  - hidden: true
    name: jira-api-key
    secure: true
    storagePath: keys/jira/jira-api-key
    valueExposed: true
  - hidden: true
    name: pd-api-key
    secure: true
    storagePath: keys/pagerduty/pd-api-key
    valueExposed: true
  - name: pd-incident-id
    value: Q0T8C01L08GEC9
  plugins:
    ExecutionLifecycle: {}
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
    - autoSecureInput: 'false'
      description: Get PD Incident Data
      fileExtension: .py
      interpreterArgsQuoted: false
      passSecureInput: 'false'
      plugins:
        LogFilter:
        - config:
            extraQuotes: 'false'
            filter: .incident.external_references[0].external_id
            logData: 'true'
            prefix: jira_id
          type: json-mapper
        - config:
            extraQuotes: 'false'
            filter: .incident.priority.summary
            logData: 'true'
            prefix: severity
          type: json-mapper
      script: |
        import requests
        import json

        url = "https://api.eu.pagerduty.com/incidents/@option.pd-incident-id@?include[]=external_references"

        payload = {}
        headers = {
          'Accept': 'application/vnd.pagerduty+json;version=2',
          'Content-Type': 'application/json',
          'Authorization': 'Token @option.pd-api-key@'
        }

        response = requests.request("GET", url, headers=headers, data=payload)

        print(response.text)
      scriptInterpreter: python -u
    - autoSecureInput: 'false'
      description: Update Jira Ticket
      fileExtension: .py
      interpreterArgsQuoted: false
      passSecureInput: 'false'
      script: |-
        import requests
        import json

        # Configuration
        severity_map_file = "/opt/apps/runner/runner/var/severity.json"

        print("Captured value: @data.jira_id@")

        # Pre-encoded base64 string (email:token)
        auth_base64 = "@option.jira-api-key@"
        headers = {
            "Authorization": f"Basic {auth_base64}",
            "Accept": "application/json"
        }

        # GET request
        get_url = "https://pdt-bdias.atlassian.net/rest/api/3/issue/@data.jira_id@"
        response_get = requests.get(get_url, headers=headers)
        print("GET response:", response_get.status_code, response_get.json())

        with open(severity_map_file, 'r') as f:
            severity_map = json.load(f)

        severity = "@data.severity@"
        mapped_value = severity_map.get(severity, "Unknown")  # Default to Sev-4 if not found
        print(f"Mapped severity '{severity}' to value '{mapped_value}'")

        # PUT request
        put_url = "https://pdt-bdias.atlassian.net/rest/api/2/issue/@data.jira_id@"
        payload = {"fields": {"customfield_10037": {"id": mapped_value}}}
        response_put = requests.put(
            put_url,
            headers={**headers, "Content-Type": "application/json"},
            json=payload
        )

        print("PUT response:", response_put.status_code, response_put.text)
      scriptInterpreter: python -u
    keepgoing: true
    strategy: node-first
  user: Bruno Dias
  uuid: 9432dc5d-933c-4b92-af81-856a102a42e8

