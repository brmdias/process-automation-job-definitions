[ {
  "defaultTab" : "nodes",
  "description" : "This is an example when Ruleset is used as Workflow Strategy - with Log Filter and Inline Script.\nThis will include:\n - 1 step in parallel of the remaining workflow\n - 1 job reference step (just running another script)\n - 1 inscript step running a script saved in the node and processing its error code\n - 1 log filter and Global Var step to expose the error code to the Ruleset\n - 2 steps running based in the step state from the previous step. These steps are also reading a Context Variable (coming from the log filter).\n - 1 step halting the execution in case of an error.\n - 1 final step to wrap-up the workflow (which only runs after specific steps)",
  "executionEnabled" : true,
  "group" : "Ruleset",
  "id" : "4de53a9d-a97a-43d6-91bf-9fe66fc4bcd9",
  "loglevel" : "INFO",
  "name" : "Ruleset example 1",
  "nodeFilterEditable" : false,
  "options" : [ {
    "label" : "File Path",
    "name" : "filepath",
    "value" : "/opt/apps/runner/test-script.sh"
  }, {
    "enforced" : true,
    "label" : "Step 3 result",
    "name" : "step-3-result",
    "value" : "0",
    "values" : [ "0", "1" ],
    "valuesListDelimiter" : ","
  } ],
  "plugins" : {
    "ExecutionLifecycle" : { }
  },
  "runnerSelector" : {
    "filter" : "LINUX",
    "runnerFilterMode" : "TAGS",
    "runnerFilterType" : "TAG_FILTER_AND"
  },
  "scheduleEnabled" : true,
  "schedules" : [ ],
  "sequence" : {
    "commands" : [ {
      "description" : "Step 1 - Parallel Execution",
      "script" : "echo \"Starting step #1\"\n\nsleep 20s\n\necho \"Completing step #1\""
    }, {
      "description" : "Step 2 - Prerequisite (Job Ref)",
      "jobref" : {
        "args" : "-filepath ${option.filepath}",
        "failOnDisable" : true,
        "group" : "Ruleset",
        "name" : "Referenced job",
        "uuid" : "0ad8669a-2dc4-4e9b-8797-12b03887438f"
      }
    }, {
      "description" : "Step 3 - Running the app script",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "regex" : "^RUNDECK:DATA:\\s*([^\\s]+?)\\s*=\\s*(.+)$",
            "replaceFilteredResult" : "false"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo \"Step #3\"\n\necho \"Step 2 result: ${2:exec.exitCode*}\"\necho \"Step 2 result: @2:exec.exitCode*@\"\n\n./test-script.sh @option.step-3-result@\n\n# Capture the exit code of the second script\nexit_code=$?\n\n# Check the exit code and act accordingly\nif [ $exit_code -ne 0 ]; then\n    echo \"test-script.sh failed with exit code $exit_code\"\n    echo \"RUNDECK:DATA:stepresult=NOK\"\n    exit $exit_code\nelse\n    echo \"test-script.sh completed successfully\"\n    echo \"RUNDECK:DATA:stepresult=OK\"\nfi\n\n"
    }, {
      "description" : "OK",
      "script" : "echo \"Step #4 - OK case\"\necho \"Step 3 via logfilter: @data.stepresult*@\"\n\nexit 0"
    }, {
      "description" : "NOK",
      "script" : "echo \"Step #4 - Not OK case\"\necho \"Step 3 result via logfilter: @data.stepresult*@\"\n\nexit 0"
    }, {
      "configuration" : {
        "debugOnly" : "false"
      },
      "description" : "Final step - wrap up",
      "nodeStep" : false,
      "type" : "log-data-step"
    }, {
      "configuration" : {
        "export" : "step-result",
        "group" : "export",
        "value" : "${data.stepresult*}"
      },
      "description" : "Export Step 3 as Global Var",
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "fail" : "true",
        "halt" : "true"
      },
      "description" : "Halt execution",
      "nodeStep" : false,
      "type" : "flow-control"
    } ],
    "keepgoing" : true,
    "pluginConfig" : {
      "WorkflowStrategy" : {
        "ruleset" : {
          "rules" : "# Autogenerated Directives\n[1] run-at-start\n[2] run-at-start\n[3] run-after:2\n[4] run-after:7 if:export.step-result==OK\n[5] run-after:7 if:export.step-result==NOK\n[6] run-after:1,4,8\n[7] run-after:3\n[8] run-after:5 if:export.step-result==NOK"
        }
      }
    },
    "strategy" : "ruleset"
  },
  "tags" : "ruleset",
  "uuid" : "4de53a9d-a97a-43d6-91bf-9fe66fc4bcd9"
} ]
