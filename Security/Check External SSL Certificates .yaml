- defaultTab: nodes
  description: "\n\n# Description: \n\nThis Automation Job, named **Check External\
    \ SSL Certificates**, is designed to validate the SSL certificate validity of\
    \ a list of specified websites. It is a simple shell script that iterates through\
    \ each site listed, checking the SSL validity using OpenSSL Client. If a certificate\
    \ is found to expire within a specified number of days (default is 7 days), it\
    \ automatically creates a PagerDuty incident for each expiring certificate. This\
    \ requires configuring a routing key as a password in the keystore.\n\n## Author\n\
    \nJustyn Roberts\n\n## Last modified\n\nModified to add PagerDuty incident creation\
    \ workflow step.\n\n# Prerequisites\n\n- RBA has a Runner installed or PAOP\n\
    - Bash script relies on OpenSSL Client\n- Python 3.x with requests library\n-\
    \ Linux tested\n- A valid PagerDuty integration key (routing key) stored in Key\
    \ Storage at keys/pagerduty/ssl-cert-monitoring-key\n\n# Options\n\n| Option \
    \         | Description                                            | Default Value\
    \ |\n|-----------------|-------------------------------------------------------|---------------|\n\
    | Validity Days   | How many days to leave grace before considering \"at risk\"\
    \ | 7             |\n| PagerDuty Routing Key | Integration key for creating PagerDuty\
    \ incidents | (from Key Storage) |\n\n# Workflow\n\n1. Loads list of websites\
    \ to check\n2. Checks SSL certificate expiration for each website\n3. Identifies\
    \ certificates expiring within threshold\n4. Captures expiring certificates as\
    \ data variables\n5. **Creates a PagerDuty incident for each expiring certificate**\n\
    \n# Disclaimer\n\nThis document and the described automation job are provided\
    \ \"as is\" without warranty of any kind, express or implied. The user assumes\
    \ all risks associated with the use of this job. The creators or contributors\
    \ are not liable for any direct, indirect, incidental, special, exemplary, or\
    \ consequential damages (including, but not limited to, procurement of substitute\
    \ goods or services; loss of use, data, or profits; or business interruption)\
    \ caused and on any theory of liability, whether in contract, strict liability,\
    \ or tort (including negligence or otherwise) arising in any way out of the use\
    \ of this job, even if advised of the possibility of such damage.\n"
  executionEnabled: true
  group: Security
  id: 0d30fafc-1930-4081-af8d-54696e18401a
  loglevel: INFO
  name: 'Check External SSL Certificates '
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: .*runner
  nodesSelectedByDefault: true
  options:
  - description: How many days to leave grace before considering "at risk"
    label: 'Validity Days '
    name: days
    value: '7'
  - description: PagerDuty Integration Key (Routing Key) for creating incidents
    label: PagerDuty Routing Key
    name: pd-routing-key
    secure: true
    storagePath: keys/pagerduty/ssl-cert-monitoring-key
    valueExposed: true
  plugins:
    ExecutionLifecycle:
      result-data-json-template:
        jsonTemplate: '{"export":{"justyn":"1"}}'
  runnerSelector:
    filter: MAIN-LINUX
    runnerFilterMode: TAGS
    runnerFilterType: TAG_FILTER_AND
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
    - args: website
      autoSecureInput: 'false'
      description: 'Website List - (Line Separated, Use this UI to edit) - Could equally
        be stored in SCM.'
      interpreterArgsQuoted: false
      passSecureInput: 'false'
      script: |-
        virtual-access-gate.telefonica.de
        telefonica.de
        www.pagerduty.com
        bdias.myrundeck.com
      scriptInterpreter: \cp -fR
    - autoSecureInput: 'false'
      description: Execute check for each website.
      passSecureInput: 'false'
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            name: abnormaloutput
            regex: ^.*Certificate\sfor\s(.*)
          type: key-value-data-multilines
      script: "#!/bin/bash\n\n# Script checks site, with optional time out of 2s\n\
        # DOMAINS= \"\" : path to line delimited external file of sites to check\n\
        \nTIMEOUT=2\nDOMAINS=\"website\"\nDAYS=@option.days@\n\nfunction child_timeout\
        \ () {\n        child=$!\n        timeout=$1\n        (\n        #trap --\
        \ \"\" SIGINT\n\n        sleep $timeout\n        if [ $(ps -o pid= -o comm=\
        \ --ppid $$ | grep -o $child) ]; then\n                kill -9 $child\n  \
        \      fi\n        ) &\nwait $child > /dev/null 2>&1\n\n}\n\nfunction checksite\
        \ () {\n\nexpirationdate=$(echo | openssl s_client -servername \"$TARGET\"\
        \ -connect \"$TARGET:443\" 2>/dev/null \\\n    | openssl x509 -noout -enddate\
        \ \\\n    | cut -d= -f2 \\\n    | xargs -I{} date -d \"{}\" +%s)\nin7days=$(($(date\
        \ +%s) + (86400*DAYS)));\n   \nif [ \"$in7days\" -gt \"$expirationdate\" ];\
        \ then\n      echo \"ğŸŸ¥ Certificate for ğŸŒ[$TARGET] expired/expires in less\
        \ than $DAYS days, on $(date -d @\"$expirationdate\" '+%Y-%m-%d')\" ;\n  \
        \    # raisePDevevent() - Could use PDCLI or Webhook here.\nelse     \n\n\
        \      echo \"ğŸŸ© $TARGET - $(date -d @\"$expirationdate\" '+%Y-%m-%d')\";\n\
        \  fi;\n}\n\n# Main loop\nwhile read -r TARGET; do\n(checksite) & child_timeout\
        \ $TIMEOUT\ndone<\"${DOMAINS}\""
    - configuration:
        export: output
        group: export
        value: ${data.abnormaloutput*}
      description: Convert Output To Variable
      errorhandler:
        exec: echo "No issues found"
        keepgoingOnSuccess: true
      nodeStep: false
      type: export-var
    - autoSecureInput: 'false'
      description: Create PagerDuty incidents for expiring certificates
      fileExtension: .py
      interpreterArgsQuoted: false
      passSecureInput: 'false'
      script: |
        import requests
        import json
        import re
        from datetime import datetime

        # PagerDuty Events API v2 endpoint
        PD_EVENTS_URL = "https://events.eu.pagerduty.com/v2/enqueue"
        ROUTING_KEY = "@option.pd-routing-key@"

        # Get the output from the previous step
        output = "@export.output@"

        if not output or output == "@export.output@":
            print("No expiring certificates found. No incidents to create.")
            exit(0)

        # Parse the output to find expiring certificates
        # Expected format: ğŸŸ¥ Certificate for ğŸŒ[domain.com] expired/expires in less than X days, on YYYY-MM-DD
        pattern = r"ğŸŸ¥ Certificate for ğŸŒ\[(.*?)\] expired/expires in less than \d+ days, on (\d{4}-\d{2}-\d{2})"

        lines = output.split('\n')
        incidents_created = 0

        for line in lines:
            match = re.search(pattern, line)
            if match:
                domain = match.group(1)
                expiry_date = match.group(2)

                # Create PagerDuty incident
                payload = {
                    "routing_key": ROUTING_KEY,
                    "event_action": "trigger",
                    "dedup_key": f"ssl-cert-{domain}",
                    "payload": {
                        "summary": f"SSL Certificate Expiring Soon: {domain}",
                        "severity": "warning",
                        "source": "Runbook Automation - SSL Certificate Monitor",
                        "component": domain,
                        "custom_details": {
                            "domain": domain,
                            "expiration_date": expiry_date,
                            "threshold_days": "@option.days@",
                            "check_time": datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                        }
                    }
                }

                try:
                    response = requests.post(
                        PD_EVENTS_URL,
                        headers={"Content-Type": "application/json"},
                        data=json.dumps(payload)
                    )

                    if response.status_code == 202:
                        print(f"âœ… PagerDuty incident created for {domain} (expires: {expiry_date})")
                        incidents_created += 1
                    else:
                        print(f"âŒ Failed to create incident for {domain}: {response.status_code} - {response.text}")
                except Exception as e:
                    print(f"âŒ Error creating incident for {domain}: {str(e)}")

        if incidents_created > 0:
            print(f"\nğŸ“Š Summary: Created {incidents_created} PagerDuty incident(s)")
        else:
            print("\nâš ï¸  No incidents were created")
      scriptInterpreter: python -u
    keepgoing: false
    strategy: node-first
  tags: security
  user: admin
  uuid: 0d30fafc-1930-4081-af8d-54696e18401a

