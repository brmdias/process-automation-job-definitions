- defaultTab: nodes
  description: >
    # Description: 


    This Automation Job, named **Check External SSL Certificates**, is designed
    to validate the SSL certificate validity of a list of specified websites. It
    is a simple shell script that iterates through each site listed, checking
    the SSL validity using OpenSSL Client. If a certificate is found to expire
    within a specified number of days (default is 7 days), it generates a
    PagerDuty alert. This requires configuring a routing key as a password in
    the keystore.


    ## Author


    Justyn Roberts


    ## Last modified


    Not specified.


    # Prerequisites


    - RBA has a Runner installed or PAOP

    - Bash script relies on OpenSSL Client

    - Linux tested

    - A valid email address of a PD user and a valid integration key stored as a
    password in the keystore are required.


    # Options


    | Option          | Description                                           |
    Default Value |

    |-----------------|-------------------------------------------------------|---------------|

    | Validity Days   | How many days to leave grace before considering "at
    risk" | 7             |


    # Disclaimer


    This document and the described automation job are provided "as is" without
    warranty of any kind, express or implied. The user assumes all risks
    associated with the use of this job. The creators or contributors are not
    liable for any direct, indirect, incidental, special, exemplary, or
    consequential damages (including, but not limited to, procurement of
    substitute goods or services; loss of use, data, or profits; or business
    interruption) caused and on any theory of liability, whether in contract,
    strict liability, or tort (including negligence or otherwise) arising in any
    way out of the use of this job, even if advised of the possibility of such
    damage.
  executionEnabled: true
  group: Security
  id: 5db08032-4312-4690-9a68-4ad2d58a7ef0
  loglevel: INFO
  name: Check External SSL Certificates - NEW IPs
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: .*runner
  nodesSelectedByDefault: true
  options:
    - description: How many days to leave grace before considering "at risk"
      label: 'Validity Days '
      name: days
      value: '30'
    - hidden: true
      name: PD_integration_key
      secure: true
      storagePath: keys/pagerduty/pdt-bdias-global-orchestration-key
      valueExposed: true
  plugins:
    ExecutionLifecycle:
      result-data-json-template:
        jsonTemplate: '{"export":{"justyn":"1"}}'
  schedule:
    month: '*'
    time:
      hour: '07'
      minute: '00'
      seconds: '0'
    weekday:
      day: '*'
    year: '*'
  scheduleEnabled: true
  schedules: []
  sequence:
    commands:
      - args: website
        autoSecureInput: 'false'
        description: >-
          Website List - (Line Separated, Use this UI to edit) - Could equally
          be stored in SCM.
        interpreterArgsQuoted: false
        passSecureInput: 'false'
        script: |
          pagerduty.com
          www.sapo.pt
        scriptInterpreter: \cp -fR
      - autoSecureInput: 'false'
        description: Execute check for each website.
        passSecureInput: 'false'
        plugins:
          LogFilter:
            - config:
                captureMultipleKeysValues: 'true'
                hideOutput: 'false'
                logData: 'true'
                name: abnormaloutput
                regex: ^.*Certificate\sfor\s(.*)
              type: key-value-data-multilines
        script: >-
          #!/bin/bash


          # Script checks site, with optional time out of 2s

          # DOMAINS= "" : path to line delimited external file of sites to check


          TIMEOUT=2

          DOMAINS="website"

          DAYS=@option.days@


          function child_timeout () {
                  child=$!
                  timeout=$1
                  (
                  #trap -- "" SIGINT

                  sleep $timeout
                  if [ $(ps -o pid= -o comm= --ppid $$ | grep -o $child) ]; then
                          kill -9 $child
                  fi
                  ) &
          wait $child > /dev/null 2>&1


          }


          function checksite () {


          expirationdate=$(echo | openssl s_client -servername "$TARGET"
          -connect "$TARGET:443" 2>/dev/null \
              | openssl x509 -noout -enddate \
              | cut -d= -f2 \
              | xargs -I{} date -d "{}" +%s)
          in7days=$(($(date +%s) + (86400*DAYS)));
             
          if [ "$in7days" -gt "$expirationdate" ]; then
                echo "üü• Certificate for üåç[$TARGET] expired/expires in less than $DAYS days, on $(date -d @"$expirationdate" '+%Y-%m-%d')" ;
                # raisePDevevent() - Could use PDCLI or Webhook here.
          else     

                echo "üü© $TARGET - $(date -d @"$expirationdate" '+%Y-%m-%d')";
            fi;
          }


          # Main loop

          while read -r TARGET; do

          (checksite) & child_timeout $TIMEOUT

          done<"${DOMAINS}"
      - configuration:
          export: output
          group: export
          value: ${data.abnormaloutput*}
        description: Convert Output To Variable
        errorhandler:
          exec: echo "No issues found"
          keepgoingOnSuccess: true
        nodeStep: false
        type: export-var
      - autoSecureInput: 'false'
        description: Create PagerDuty events for expiring certificates
        fileExtension: .py
        interpreterArgsQuoted: false
        passSecureInput: 'false'
        script: >-
          import requests

          import re


          # Rundeck API configuration

          RUNDECK_BASE_URL = "https://bdias.myrundeck.com"

          RUNDECK_API_TOKEN = "@option.rundeck_token@"

          TARGET_JOB_UUID = "c5bfdd78-8569-471e-a52d-06e2d44c1267"


          # Get the output from the previous step

          output = """@export.output@"""

          print(f"{output}")


          if not output:
              print("No expiring certificates found. No incidents to create.")
              exit(0)

          # Parse the output to find expiring certificates

          # Expected format: üü• Certificate for üåç[domain.com] expired/expires
          in less than X days, on YYYY-MM-DD

          pattern = re.compile(
              r'^\s*üåç\[(?P<domain>[^\]]+)\]\s+expired/expires in less than\s+(?P<days>\d+)\s+days, on\s+(?P<date>\d{4}-\d{2}-\d{2})\s*$'
          )


          lines = output.splitlines()

          jobs_triggered = 0


          for line in lines:
              m = pattern.search(line)
              if not m:
                  continue
              domain = m.group('domain')
              expiry_date = m.group('date')
              # days = int(m.group('days'))  # if you need it

              # Trigger Rundeck job
              payload = {
                  "options": {
                      "domain": domain,
                      "expiry_date": expiry_date
                  }
              }

              try:
                  response = requests.post(
                      f"{RUNDECK_BASE_URL}/api/45/job/{TARGET_JOB_UUID}/run",
                      headers={
                          "Content-Type": "application/json",
                          "X-Rundeck-Auth-Token": RUNDECK_API_TOKEN
                      },
                      json=payload
                  )

                  if response.status_code == 200:
                      execution_id = response.json().get('id')
                      print(f"‚úÖ Rundeck job triggered for {domain} (expires: {expiry_date}) - Execution ID: {execution_id}")
                      jobs_triggered += 1
                  else:
                      print(f"‚ùå Failed to trigger job for {domain}: {response.status_code} - {response.text}")
              except Exception as e:
                  print(f"‚ùå Error triggering job for {domain}: {str(e)}")

          if jobs_triggered > 0:
              print(f"\nüìä Summary: Triggered {jobs_triggered} Rundeck job execution(s)")
          else:
              print("\n‚ö†Ô∏è  No jobs were triggered")
        scriptInterpreter: python -u
    keepgoing: false
    pluginConfig:
      WorkflowStrategy:
        ruleset:
          rules: |-
            [*] run-in-sequence
            [4] unless:!export.output
    strategy: ruleset
  tags: security
  timeZone: Europe/Lisbon
  user: appadmin
  uuid: 5db08032-4312-4690-9a68-4ad2d58a7ef0
